<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Treemap with Enhanced Features</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
    crossorigin="anonymous"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background: linear-gradient(to right, #f0f0f0, #e0e0e0);
    }

    .treemap-container {
      width: 50%;
      position: relative;
      margin: auto;
    }

    .tile {
      position: absolute;
      border: 1px solid #fff;
      background-color: #ddd;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: Arial, sans-serif;
      font-size: 12px;
      color: white;
      text-shadow: 1px 1px 2px black;
      overflow: hidden;
      margin-top: 25vh;
    }

    .tile.active {
      border: 3px solid purple;
      transform: scale(1.5);
      /* height: 15rem !important;
      width: 15rem !important; */
      z-index: 9;
    }

    .tile .github-handle {
      position: absolute;
      bottom: 5px;
      left: 5px;
      background: rgba(0, 0, 0, 0.6);
      padding: 2px 5px;
      border-radius: 3px;
    }


    .tile img {
      width: 100%;
      height: 100%;
      object-fit: fill;
      transition: transform 0.3s ease;
    }

    .tooltip {
      position: absolute;
      padding: 5px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      border-radius: 5px;
      visibility: hidden;
      z-index: 99;
    }

    .hover-image {
      position: absolute;
      transition: transform 0.3s ease;
      pointer-events: none;
      transform-origin: center;
    }

    .hover-image img {
      transition: transform 0.3s ease;
    }

    .hover-image img:hover {
      transform: scale(1.5);
    }

    .card-container {
      height: 100vh;
      z-index: 9999;
      position: relative;
    }

    .background-separator {
      background-color: #717171b5;
      z-index: 999;
      height: 100vh;
      width: 100vw;
      position: absolute;
    }

    .btn-close {
      top: 0;
      right: 0;
      position: absolute;
    }
  </style>
</head>

<body>
  <div id="treemap" class="treemap-container"></div>
  <div class="tooltip" id="tooltip"></div>

  <div class="profile-container d-none">
    <div class="background-separator"></div>
    <div class="card-container d-flex align-items-center">
      <div class="card mx-auto" style="width: 18rem;">
        <button type="button" class="btn-close" aria-label="Close" onclick="closeCard()"></button>
        <img src="..." class="card-img-top" alt="...">
        <div class="card-body">
          <h5 class="card-title">Github username</h5>
          <p class="card-text">Github Profile</p>
          <a href="#" class="btn btn-primary">Go somewhere</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    async function fetchContributors(owner, repo) {
      const response = await fetch(
        `https://api.github.com/repos/${owner}/${repo}/contributors?per_page=100`
      );
      if (!response.ok) {
        alert("Error fetching contributors.");
        throw new Error("Failed to fetch contributors");
      }
      return await response.json();
    }

    function scaleContributions(data) {
      const maxContribution = d3.max(data, (d) => d.value);
      const minContribution = d3.min(data, (d) => d.value);

      const scale = d3
        .scaleSqrt()
        .domain([minContribution, maxContribution])
        .range([10, 100]); // Increased minimum size

      return data.map((d) => ({
        ...d,
        scaledValue: scale(d.value),
      }));
    }


    function closeCard() {
      const profileContainer = document.querySelector(".profile-container");
      profileContainer.classList.add("d-none");
    }


    async function createTreemap(owner, repo) {
      const contributors = await fetchContributors(owner, repo);

      const topContributors = contributors
        .slice(0, 100)
        .map((contributor) => ({
          name: contributor.login,
          value: contributor.contributions,
          avatar: contributor.avatar_url,
          contributions: contributor.contributions,
        }));

      const scaledData = scaleContributions(topContributors);

      const width = window.innerWidth;
      const height = window.innerHeight;

      const treemap = d3.treemap().size([width, height]).padding(2);

      const root = d3
        .hierarchy({ children: scaledData })
        .sum((d) => d.scaledValue);

      treemap(root);

      const treemapContainer = document.querySelector("#treemap");

      root.leaves().forEach((d) => {
        const tile = document.createElement("div");
        tile.classList.add("tile");
        tile.style.left = `${d.x0 / 2}px`;
        tile.style.top = `${d.y0 / 2}px`;
        tile.style.width = `${(d.x1 - d.x0) / 2}px`;
        tile.style.height = `${(d.y1 - d.y0) / 2}px`;

        const img = document.createElement("img");
        img.src = d.data.avatar;
        tile.appendChild(img);

        // const handle = document.createElement("div");
        // handle.classList.add("github-handle");
        // handle.textContent = `@${d.data.name}`;
        // tile.appendChild(handle);

        tile.addEventListener("mouseenter", (event) => {
          const tooltip = document.querySelector("#tooltip");
          tooltip.style.visibility = "visible";
          tooltip.textContent = `@${d.data.name}: ${d.data.contributions} contributions`;
          tooltip.style.left = `${event.pageX}px`;
          tooltip.style.top = `${event.pageY}px`;

          tile.classList.add("active");
        });

        tile.addEventListener("mouseleave", () => {
          document.querySelector("#tooltip").style.visibility = "hidden";
          tile.classList.remove("active");
        });

        tile.addEventListener("click", () => {
          const profileContainer = document.querySelector(".profile-container");
          profileContainer.classList.remove("d-none");

          const card = profileContainer.querySelector(".card");
          const img = card.querySelector("img");
          img.src = d.data.avatar;

          const title = card.querySelector(".card-title");
          title.textContent = d.data.name;

          const text = card.querySelector(".card-text");
          text.textContent = `@${d.data.name}: ${d.data.contributions} contributions`;

          const btn = card.querySelector(".btn");
          btn.textContent = "View on GitHub";
          btn.href = `https://github.com/${d.data.name}`;
        });

        treemapContainer.appendChild(tile);
      });

      window.addEventListener("resize", () => {
        const width = window.innerWidth;
        const height = window.innerHeight;
        treemap.size([width, height]);

        treemap(root); // Recompute treemap layout on resize

        const tiles = treemapContainer.querySelectorAll(".tile");
        tiles.forEach((tile, i) => {
          const d = root.leaves()[i];
          tile.style.left = `${d.x0 / 2} px`;
          tile.style.top = `${d.y0 / 2} px`;
          tile.style.width = `${(d.x1 - d.x0) / 2} px`;
          tile.style.height = `${(d.y1 - d.y0) / 2} px`;

          const img = tile.querySelector("img");
          img.style.width = `${(d.x1 - d.x0) / 2} px`;
          img.style.height = `${(d.y1 - d.y0) / 2} px`;
        });

        // Update tooltip position on resize
        const tooltip = document.querySelector("#tooltip");
        tooltip.style.left = `${Math.min(
          window.innerWidth - tooltip.clientWidth,
          parseInt(tooltip.style.left)
        )
          } px`;
        tooltip.style.top = `${Math.min(
          window.innerHeight - tooltip.clientHeight,
          parseInt(tooltip.style.top)
        )
          } px`;
      });
    }

    function getScaleFactor(width, minSize, maxSize) {
      const minScale = 1.2;
      const maxScale = 2.0;

      return (
        maxScale - ((width - minSize) / (maxSize - minSize)) * (maxScale - minScale)
      );
    }

    // Compute min and max size dynamically
    function computeMinMaxSize() {
      const tileElements = document.querySelectorAll(".tile");
      if (tileElements.length === 0) return { minSize: 10, maxSize: 100 }; // Fallback

      let minSize = Infinity;
      let maxSize = -Infinity;

      tileElements.forEach((tile) => {
        const width = tile.offsetWidth;
        if (width < minSize) minSize = width;
        if (width > maxSize) maxSize = width;
      });

      return { minSize, maxSize };
    }

    function applyHoverEffect() {
      const { minSize, maxSize } = computeMinMaxSize();

      document.querySelectorAll(".tile").forEach((tile) => {
        const width = tile.offsetWidth;
        const scaleFactor = getScaleFactor(width, minSize, maxSize);

        tile.addEventListener("mouseenter", () => {
          // console.log("scaleFactor", scaleFactor);
          tile.style.transform = `scale(${scaleFactor})`;
          tile.style.zIndex = "9";
        });

        tile.addEventListener("mouseleave", () => {
          tile.style.transform = "scale(1)";
          tile.style.zIndex = "1";
        });
      });
    }

    createTreemap("microsoft", "vscode");
    setTimeout(applyHoverEffect, 500);
  </script>
</body>

</html>

<!-- 
TODO: 
1. decide: should go for full page or dynamic size treegraph - full page
2. on hover,picture should enlarge to display full profile picture on big scale and also highlight the border of rectangle
3. on click, should redirect to profile page and before that prompt to confirm the action
4. on click, should display the profile picture in the center of the screen
5. Should be downloadable as a pdf, png, jpeg, svg
6. Should be able to share the profile picture from the svg/treegraph on social media which on click highlights the profile picture in the svg/treegraph
7. each user can also provide their respective portfolio links (can be one/multiple) which on click should redirect to the respective portfolio page
8. display no. of contributions on hover

Issues:
1. Limited Interaction for Small Rectangles: 
2. Visual Overwhelm:
3. Labeling Limitations:
4. Hover Effects and Responsiveness: 
5. Scaling Issues on Different Devices:

 -->